<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLSX to YAML Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-900">
    <div class="min-h-screen p-4">
        <!-- Header -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="text-center py-8">
                <h1 class="text-4xl font-extrabold text-white mb-4">
                    XLSX to YAML Converter
                </h1>
                <p class="text-lg text-gray-400">
                    Convert Excel spreadsheets to YAML format
                </p>
            </div>
        </div>

        <!-- Main Container -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                <!-- Upload Section -->
                <div class="mb-6">
                    <div class="flex items-center justify-center w-full">
                        <label id="uploadArea" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-700 hover:bg-gray-600 hover:border-gray-500 transition-all duration-300">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                                </svg>
                                <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-400">XLSX or XLS files only</p>
                            </div>
                            <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls" />
                        </label>
                    </div>
                </div>

                <!-- File Info Alert -->
                <div id="fileInfo" class="hidden p-4 mb-4 text-sm text-blue-400 rounded-lg bg-gray-800 border border-blue-800" role="alert">
                    <div class="flex items-center">
                        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                        </svg>
                        <div>
                            <span class="font-medium">File loaded:</span> <span id="fileName"></span>
                            <div class="mt-1">
                                <span class="font-medium">Sheets:</span> <span id="sheetCount"></span> | 
                                <span class="font-medium">Total Records:</span> <span id="recordCount"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="errorMsg" class="hidden p-4 mb-4 text-sm text-red-400 rounded-lg bg-gray-800 border border-red-800" role="alert">
                    <div class="flex items-center">
                        <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                        </svg>
                        <span id="errorText"></span>
                    </div>
                </div>

                <!-- Sheet Selector -->
                <div id="sheetSelector" class="hidden mb-6">
                    <label for="sheetSelect" class="block mb-2 text-sm font-medium text-white">Select Sheet to Convert</label>
                    <select id="sheetSelect" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="__all__">All Sheets</option>
                    </select>
                </div>

                <!-- Options Section -->
                <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Conversion Options</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input id="cleanFields" type="checkbox" checked class="w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-600 focus:ring-offset-gray-800 focus:ring-2">
                            <label for="cleanFields" class="ms-2 text-sm font-medium text-gray-300">Clean field names</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input id="skipEmpty" type="checkbox" checked class="w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-600 focus:ring-offset-gray-800 focus:ring-2">
                            <label for="skipEmpty" class="ms-2 text-sm font-medium text-gray-300">Skip empty values</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input id="skipEmptyRows" type="checkbox" checked class="w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-600 focus:ring-offset-gray-800 focus:ring-2">
                            <label for="skipEmptyRows" class="ms-2 text-sm font-medium text-gray-300">Skip empty rows</label>
                        </div>
                        
                        <div class="flex items-center">
                            <label for="namingConvention" class="text-sm font-medium text-gray-300 me-2">Naming convention:</label>
                            <select id="namingConvention" class="bg-gray-600 border border-gray-500 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="camelCase">camelCase</option>
                                <option value="snake_case">snake_case</option>
                                <option value="kebab-case">kebab-case</option>
                                <option value="lowercase">lowercase</option>
                                <option value="original">Keep Original</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center">
                            <label for="startRow" class="text-sm font-medium text-gray-300 me-2">Start from row:</label>
                            <input type="number" id="startRow" value="1" min="1" class="bg-gray-600 border border-gray-500 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-20 p-2">
                            <span class="ms-2 text-xs text-gray-400">(1 = first row)</span>
                        </div>
                    </div>
                    
                    <!-- Field Selection Section -->
                    <div id="keySelectionSection" class="mt-4 p-4 bg-gray-600 rounded-lg">
                        <h4 class="text-md font-semibold text-white mb-3">Customize Field Names for YAML Output</h4>
                        <div class="flex items-center mb-3">
                            <button id="selectAllKeys" type="button" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2">Include All</button>
                            <button id="deselectAllKeys" type="button" class="text-xs bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded mr-2">Exclude All</button>
                            <button id="resetFieldNames" type="button" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Reset Names</button>
                        </div>
                        <div id="keyCheckboxes" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Field inputs will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Convert Button -->
                <div class="flex justify-center mb-6">
                    <button id="convertBtn" disabled class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        <svg class="inline w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4.5V19a1 1 0 0 0 1 1h15M7 14l4-4 4 4 5-5m0 0h-3.207M20 9v3.207"/>
                        </svg>
                        Convert to YAML
                    </button>
                </div>

                <!-- Output Section -->
                <div id="outputSection" class="hidden">
                    <div class="mb-4">
                        <label for="yamlOutput" class="block mb-2 text-sm font-medium text-white">YAML Output</label>
                        <textarea id="yamlOutput" rows="12" readonly class="block p-2.5 w-full text-sm text-gray-300 bg-gray-700 rounded-lg border border-gray-600 focus:ring-blue-500 focus:border-blue-500 font-mono"></textarea>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="flex items-center text-sm text-gray-400">
                            <svg class="w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 10 2 2 4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                            </svg>
                            Conversion successful
                        </div>
                        
                        <button id="downloadBtn" type="button" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-800 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none transition-all">
                            <svg class="inline w-4 h-4 me-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 19">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15h.01M4 12H2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-3M9.5 1v10.93m4-3.93-4 4-4-4"/>
                            </svg>
                            Download YAML
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center text-sm text-gray-400">
                <p>Convert Excel files to YAML format directly in your browser. No data is uploaded to any server.</p>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let fileName = '';

        // Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const convertBtn = document.getElementById('convertBtn');
        const outputSection = document.getElementById('outputSection');
        const yamlOutput = document.getElementById('yamlOutput');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');
        const sheetSelector = document.getElementById('sheetSelector');
        const sheetSelect = document.getElementById('sheetSelect');

        // Options
        const cleanFieldsOpt = document.getElementById('cleanFields');
        const skipEmptyOpt = document.getElementById('skipEmpty');
        const skipEmptyRowsOpt = document.getElementById('skipEmptyRows');
        const startRowOpt = document.getElementById('startRow');
        const namingConventionOpt = document.getElementById('namingConvention');
        
        // Key selection elements
        const keySelectionSection = document.getElementById('keySelectionSection');
        const keyCheckboxes = document.getElementById('keyCheckboxes');
        const selectAllKeysBtn = document.getElementById('selectAllKeys');
        const deselectAllKeysBtn = document.getElementById('deselectAllKeys');
        const resetFieldNamesBtn = document.getElementById('resetFieldNames');
        
        let availableFields = new Set();
        let includedFields = new Set();
        let fieldNameMappings = new Map(); // Maps original field name to custom field name

        // File handling
        // Note: uploadArea is a label element, so it naturally triggers fileInput when clicked
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-500', 'bg-gray-600');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-blue-500', 'bg-gray-600');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500', 'bg-gray-600');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Sheet selector event listener to update field selections
        sheetSelect.addEventListener('change', () => {
            collectAvailableFields();
        });
        
        // Start row input event listener to update field selections
        startRowOpt.addEventListener('change', () => {
            if (workbook) {
                collectAvailableFields();
            }
        });
        
        // Naming convention dropdown event listener to update field names
        namingConventionOpt.addEventListener('change', () => {
            if (workbook && availableFields.size > 0) {
                // Update field name mappings with new convention
                availableFields.forEach(field => {
                    fieldNameMappings.set(field, cleanFieldName(field));
                });
                // Repopulate the field inputs with updated names
                populateFieldInputs();
            }
        });
        
        // Include/Exclude all fields event listeners
        selectAllKeysBtn.addEventListener('click', () => {
            const checkboxes = keyCheckboxes.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                includedFields.add(cb.value);
            });
        });
        
        deselectAllKeysBtn.addEventListener('click', () => {
            const checkboxes = keyCheckboxes.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                includedFields.delete(cb.value);
            });
        });
        
        // Reset field names to default (cleaned) names
        resetFieldNamesBtn.addEventListener('click', () => {
            const textInputs = keyCheckboxes.querySelectorAll('input[type="text"]');
            textInputs.forEach(input => {
                const originalField = input.dataset.originalField;
                const defaultName = cleanFieldName(originalField);
                input.value = defaultName;
                fieldNameMappings.set(originalField, defaultName);
            });
        });

        function handleFile(file) {
            fileName = file.name;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    // Populate sheet selector
                    sheetSelect.innerHTML = '';
                    workbook.SheetNames.forEach(sheetName => {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelect.appendChild(option);
                    });
                    
                    // Select first sheet by default
                    if (workbook.SheetNames.length > 0) {
                        sheetSelect.value = workbook.SheetNames[0];
                    }
                    
                    // Show file info
                    document.getElementById('fileName').textContent = fileName;
                    document.getElementById('sheetCount').textContent = workbook.SheetNames.length;
                    
                    let totalRecords = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet);
                        totalRecords += data.length;
                    });
                    
                    document.getElementById('recordCount').textContent = totalRecords;
                    
                    // Collect available fields for inclusion selection
                    collectAvailableFields();
                    
                    fileInfo.classList.remove('hidden');
                    sheetSelector.classList.remove('hidden');
                    convertBtn.disabled = false;
                    errorMsg.classList.add('hidden');
                    outputSection.classList.add('hidden');
                } catch (error) {
                    showError('Error reading file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function collectAvailableFields() {
            availableFields.clear();
            includedFields.clear();
            fieldNameMappings.clear();
            
            const selectedSheet = sheetSelect.value;
            if (!selectedSheet) return;
            
            // Process only the selected sheet
            const sheet = workbook.Sheets[selectedSheet];
            const rawData = XLSX.utils.sheet_to_json(sheet, { 
                header: 1,
                defval: null,
                blankrows: true
            });
            
            const startRow = parseInt(startRowOpt.value) - 1;
            if (rawData.length > startRow) {
                const headers = rawData[startRow];
                if (headers && headers.length > 0) {
                    headers.forEach(header => {
                        if (header && typeof header === 'string') {
                            // Store the original header for comparison
                            availableFields.add(header);
                            includedFields.add(header); // Default to all included
                            // Initialize field name mapping with cleaned name
                            fieldNameMappings.set(header, cleanFieldName(header));
                        }
                    });
                }
            }
            
            // Always show field selection section when fields are available
            if (availableFields.size > 0) {
                populateFieldInputs();
            }
        }
        
        function populateFieldInputs() {
            keyCheckboxes.innerHTML = '';
            
            Array.from(availableFields).sort().forEach(field => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3 p-2 bg-gray-700 rounded';
                
                // Checkbox for include/exclude
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `field_${field.replace(/[^a-zA-Z0-9]/g, '_')}`;
                checkbox.value = field;
                checkbox.checked = includedFields.has(field);
                checkbox.className = 'w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-600 focus:ring-offset-gray-800 focus:ring-2';
                
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        includedFields.add(field);
                    } else {
                        includedFields.delete(field);
                    }
                });
                
                // Original field name label
                const originalLabel = document.createElement('div');
                originalLabel.className = 'text-xs text-gray-300 min-w-0 flex-1';
                originalLabel.textContent = field;
                originalLabel.title = `Original field: ${field}`;
                
                // Arrow
                const arrow = document.createElement('div');
                arrow.className = 'text-gray-400 text-xs';
                arrow.textContent = 'â†’';
                
                // Text input for custom field name
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = fieldNameMappings.get(field) || cleanFieldName(field);
                textInput.dataset.originalField = field;
                textInput.className = 'bg-gray-600 border border-gray-500 text-white text-xs rounded px-2 py-1 min-w-0 flex-1 focus:ring-blue-500 focus:border-blue-500';
                textInput.placeholder = 'Output field name';
                
                textInput.addEventListener('input', (e) => {
                    fieldNameMappings.set(field, e.target.value);
                });
                
                div.appendChild(checkbox);
                div.appendChild(originalLabel);
                div.appendChild(arrow);
                div.appendChild(textInput);
                keyCheckboxes.appendChild(div);
            });
        }

        function showError(message) {
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
            convertBtn.disabled = true;
        }

        function toCamelCase(str) {
            return str.replace(/(?:^\w|[A-Z]|\b\w)/g, (word, index) => {
                return index === 0 ? word.toLowerCase() : word.toUpperCase();
            }).replace(/\s+/g, '');
        }
        
        function toSnakeCase(str) {
            return str.replace(/\W+/g, ' ')
                .split(/ |\s/)
                .map(word => word.toLowerCase())
                .join('_');
        }
        
        function toKebabCase(str) {
            return str.replace(/\W+/g, ' ')
                .split(/ |\s/)
                .map(word => word.toLowerCase())
                .join('-');
        }
        
        function applyNamingConvention(fieldName) {
            const convention = namingConventionOpt.value;
            
            switch (convention) {
                case 'camelCase':
                    return toCamelCase(fieldName);
                case 'snake_case':
                    return toSnakeCase(fieldName);
                case 'kebab-case':
                    return toKebabCase(fieldName);
                case 'lowercase':
                    return fieldName.replace(/\W+/g, '').toLowerCase();
                case 'original':
                    return fieldName;
                default:
                    return toCamelCase(fieldName);
            }
        }
        
        function cleanFieldName(fieldName) {
            if (!fieldName) return fieldName;
            
            let cleanedName = fieldName;
            
            // Apply field cleaning if enabled
            if (cleanFieldsOpt.checked) {
                cleanedName = cleanedName
                    .replace(/\r?\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // Apply naming convention
            cleanedName = applyNamingConvention(cleanedName);
            
            return cleanedName;
        }

        function cleanValue(value) {
            if (typeof value === 'string') {
                return value.trim();
            }
            return value;
        }

        function isEmptyRow(row) {
            return Object.values(row).every(val => 
                val === null || val === undefined || val === ''
            );
        }

        function processSheet(sheetName) {
            const sheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(sheet, { 
                header: 1,
                defval: null,
                blankrows: true
            });
            
            const startRow = parseInt(startRowOpt.value) - 1;
            if (rawData.length <= startRow) return null;
            
            const headers = rawData[startRow];
            if (!headers || headers.length === 0) return null;
            
            const sheetData = [];
            
            for (let i = startRow + 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || row.length === 0) continue;
                
                const rowObject = {};
                let hasData = false;
                
                headers.forEach((originalHeader, index) => {
                    // Only include fields that are selected in the includedFields set (using original header)
                    if (originalHeader && includedFields.has(originalHeader) && row[index] !== undefined && row[index] !== null) {
                        const cleanedValue = cleanValue(row[index]);
                        if (!skipEmptyOpt.checked || cleanedValue !== '') {
                            // Use custom field name from mappings, or fall back to cleaned name
                            const customFieldName = fieldNameMappings.get(originalHeader) || cleanFieldName(originalHeader);
                            rowObject[customFieldName] = cleanedValue;
                            hasData = true;
                        }
                    }
                });
                
                if (hasData && (!skipEmptyRowsOpt.checked || !isEmptyRow(rowObject))) {
                    sheetData.push(rowObject);
                }
            }
            
            return sheetData.length > 0 ? sheetData : null;
        }

        convertBtn.addEventListener('click', () => {
            if (!workbook) return;
            
            try {
                const selectedSheet = sheetSelect.value;
                if (!selectedSheet) {
                    showError('No sheet selected');
                    return;
                }
                
                // Process only the selected sheet
                const result = processSheet(selectedSheet);
                
                if (!result || result.length === 0) {
                    showError('No data found to convert');
                    return;
                }
                
                const yamlStr = jsyaml.dump(result, {
                    indent: 2,
                    lineWidth: -1,
                    noRefs: true,
                    sortKeys: false
                });
                
                yamlOutput.value = yamlStr;
                outputSection.classList.remove('hidden');
                
                // Scroll to output
                outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                showError('Error converting to YAML: ' + error.message);
            }
        });

        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([yamlOutput.value], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Include sheet name in filename
            const selectedSheet = sheetSelect.value;
            let downloadName = fileName.replace(/\.[^.]+$/, '');
            if (selectedSheet) {
                downloadName += '_' + selectedSheet.replace(/[^a-zA-Z0-9]/g, '_');
            }
            downloadName += '.yaml';
            
            a.download = downloadName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
